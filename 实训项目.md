

# 项目搭建

## 1.创建项目

### 1.1 创建父项目

创建maven项目 

此项目为父项目,不需要写代码,可以删除src文件夹.

​	向pom.xml文件导入相关依赖

```xml
	<!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <properties>
        <!--项目构建编码-->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        <!--声明JDK版本-->
        <java.version>1.8</java.version>
        <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
        <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
    </properties>
    <!--boot 版本-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <!--始终从仓库中获取，不从本地路径获取-->
        <relativePath />
    </parent>
    <dependencies>
        <!-- 集成commons工具类 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <!-- 集成lombok 框架 -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!--junit测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- SpringBoot整合eureka客户端 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--boot 测试模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <!-- 项目依赖,子级模块可以继承依赖-->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${mr.spring.cloud.version}</version>
                <type>pom</type>
                <!--解决maven单继承的问题-->
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/libs-milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>
```



### 1.2 创建服务父工程

​	1.2.1、在mingrui-shop-parent右键 -> new -> module，项目名为 mingrui-shop-basics

​	1.2.2、pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```

### 1.3 创建工具工程

​	1.3.1、在mingrui-shop-parent右键 -> new -> module，项目名为 mingrui-shop-commons

​	1.3.2、pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```

### 1.4 创建服务实现工程

​	1.4.1、在mingrui-shop-parent右键 -> new -> module，项目名为 mingrui-shop-service

​	1.4.2、pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!-- springcloud feign组件 -->
    <dependency>
    	<groupId>org.springframework.cloud</groupId>
    	<artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>
</dependencies>
```

### 1.5 创建服务接口工程

​		1.5.1、在mingrui-shop-parent右键 -> new -> module，项目名为 mingrui-shop-service-api

​		1.5.2、pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
<dependencies>
	<!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

### 1.6 创建eureka服务

​	1.6.1、在mingrui-shop-basics右键 -> new -> module，项目名为 mingrui-shop-basic-eureka-server

​	1.6.2、pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-basics</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
	<modelVersion>4.0.0</modelVersion>
	<artifactId>mingrui-shop-basic-eureka-server</artifactId>
    <dependencies>
        <!--eureka 服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>
</project>

```

​	1.6.3、application.yml

```properties
server:
	port: 8761
spring:
	application:
		name: eureka-server
eureka:
	client:
        # eureka服务url,值为map集合默认key为defaultZone
        service-url:
			defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
        # 当前服务是否同时注册
        register-with-eureka: false
        # 去注册中心获取其他服务的地址
        fetch-registry: false
    instance:
    	hostname: localhost
        # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
        lease-renewal-interval-in-seconds: 1
        # 定义服务失效的时间，单位：秒 默认90
        lease-expiration-duration-in-seconds: 2
	server:
        # 测试时关闭自我保护机制，保证不可用服务及时踢出
        enable-self-preservation: false

```

​	1.6.4、启动类

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;


/**
* @ClassName RunEurekaServerApplication
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/14
* @Version V1.0
**/
@SpringBootApplication
@EnableEurekaServer
public class RunEurekaServerApplication {
    
    public static void main(String[] args) {
    	SpringApplication.run(RunEurekaServerApplication.class);
    }
    
}
```

## 2.使用域名访问本地项目

### 	2.1 解决域名解析问题

​		2.1.1、修改本地hosts文件域名，文件地址:    C:\Windows\System32\etc\hosts

​		127.0.0.1 api.mrshop.com 

​		127.0.0.1 manage.mrshop.com

​		使用cmd测试域名是否通畅

#### 	2.2.1 测试

​		使用vue项目测试

​		在build下的webpack.dev.conf.js文件的server下增加

​		disableHostCheck: true,

#### 		2.2.2 使用nginx解决端口问题

​		修改nginx目录下的conf文件夹下的nginx.conf文件

​		

```
#user nobody;
worker_processes 1;

#error_log logs/error.log;
#error_log logs/error.log notice;
#error_log logs/error.log info;
#pid logs/nginx.pid;

events {
	worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    server {
        listen 80;
        server_name manage.mrshop.com;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        location / {
            proxy_pass http://127.0.0.1:9001;
            proxy_connect_timeout 600;
            proxy_read_timeout 600;
        }
    }
    server {
        listen 80;
        server_name api.mrshop.com;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        location / {
            proxy_pass http://127.0.0.1:8088;
            proxy_connect_timeout 600;
            proxy_read_timeout 600;
        }
    }
}
```

再次测试就成功了

# 商品分类

## 商品分类管理(查询)

### 1 mingrui-shop--commons

##### 1.1在mingrui-shop--commons项目下新建mingrui-shopcommon-core项目

##### 1.2 pom.xml

```xml
    <!--处理json与各种数据类型或文档类型的转换-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>
    <!--json对象序列化和反序列化的支持-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--java对象和json对象之间的转换-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--alibaba的json处理工具-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.62</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.11.2</version>
    </dependency>
```

##### 1.3 新建包com.baidu.shop.utils

##### 1.4 新建JSONUtil类

```java
import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author sunpeihao
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class JSONUtil {

    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }
    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }


}
```



##### 1.5 新建包com.baidu.shop.status

##### 1.6 新建HTTPStatus类

```java
public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

##### 1.7 新建包 com.baidu.shop.base

##### 1.8 新建Result类

```java
public class Result<T> {

    private Integer code;//返回码

    private String message;//返回消息

    private T data;//返回数据

    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}
```

### 2 mingrui-shop-service-api工程

##### 2.1 mingrui-shop-service-api/pom.xml

```xml
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--Entity 中的@Table 和@Id需要次注解-->
    <dependency>
        <groupId>javax.persistence</groupId>
        <artifactId>persistence-api</artifactId>
        <version>1.0.2</version>
    </dependency>
    <!--2.3版本之后web删除了验证插件-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
    <!--引入common工程代码-->
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shop-common-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

##### 2.2 在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

##### 2.3 pom.xml

```xml
<dependencies>
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>
    <!--提供可视化的API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <version>2.9.2</version>
    </dependency>
</dependencies>
```

##### 2.4 新建包com.baidu.shop.entity

##### 2.5 创建商品分类实体类 CategoryEntity

##### 2.6 创建 swagger2的配置类

##### 2.7 定义商品分类接口

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
/**
* @ClassName Category
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/17
* @Version V1.0
**/
@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}
```

### 3 mingrui-shop-service

##### 3.1 mingrui-shop-service/pom.xml

```xml
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

##### 3.2 在mingrui-shop-service工程下新建mingrui-shop-servicexxx工程

##### 3.3 在resources下创建application.yml

```properties
server:
	port: 8100
spring:
	application:
		name: xxx-server
    # 配置数据源
    datasource:
        # 数据源名称，任意
        name: mysql
        url: jdbc:mysql://ip:3306/mr-shop?
useSSL=true&nullNamePatternMatchesAll=true&serverTimezone=GMT%2B8&useUnicode=tru
e&characterEncoding=utf8
        # 数据库连接用户
        username: root
        # 数据库连接密码
        password: pwd
        # 驱动名称
        driver-class-name: com.mysql.cj.jdbc.Driver
        # boot2.0+使用hikari作为默认数据库连接池
        type: com.zaxxer.hikari.HikariDataSource
        hikari:
            # 是否自动提交事务 默认
            auto-commit: true
            # 允许的最小连接数
            minimum-idle: 5
            # 连接池内最大连接数
            maximum-pool-size: 10
            # 验证连接的sql语句
            connection-test-query: SELECT 1 FROM DUAL
            # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
            connection-timeout: 30000
            # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
            validation-timeout: 5000
            # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
            max-lifetime: 1800000
# 通用mapper
mapper:
    mappers: tk.mybatis.mapper.common.Mapper
    identity: MYSQL
#日志设置
logging:
    level:
    # 打印与我们程序相关的日志信息
		com.baidu.shop: debug
# eureka配置
eureka:
	client:
		service-url:
			defaultZone: http://localhost:8761/eureka/
```

##### 3.4 新建包com.baidu

##### 3.5 新建启动类

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;
/**
* @ClassName RunXXXApplication
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/17
* @Version V1.0
**/
@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {
    public static void main(String[] args) {
    	SpringApplication.run(RunXXXApplication.class);
    }
}

```

##### 3.6 在com.baidu下新建包shop.mapper

##### 3.7 创建mapper

```java
import com.baidu.shop.entity.CategoryEntity;
import tk.mybatis.mapper.common.Mapper;
/**
* @ClassName CategoryMapper
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/17
* @Version V1.0
**/
public interface CategoryMapper extends Mapper<CategoryEntity> {
}
```

##### 3.8 新建实现类

```java
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;
/**
* @ClassName CategoryServiceImpl
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/17
* @Version V1.0
**/
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {
    
    @Autowired
    private CategoryMapper categoryMapper;
    
    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        
        CategoryEntity categoryEntity = new CategoryEntity();
        
        categoryEntity.setParentId(pid);
        
        List<CategoryEntity> list = categoryMapper.select(categoryEntity);
        
        return this.setResultSuccess(list);
    }
}

```

### 4 网关服务

##### 4.1 在mingrui-shop-basic项目下新建mingrui-shop-basiczuul-server

##### 4.2 pom.xml

```xml
<dependencies>
    
    <!-- zuul -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
    </dependency>
    
</dependencies>

```

##### 4.3 application.yml

```properties
server:
	port: 8088
	
spring:
	application:
		name: eureka-zuul
		
zuul:
	# 声明路由
	routes:
        # 路由名称
        api-xxx:
            # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
            path: /api-xxx/**
            serviceId: xxx-server
    # 启用重试
    retryable: true
#配置负载
ribbon:
    ConnectTimeout: 250 # 连接超时时间(ms)
    ReadTimeout: 2000 # 通信超时时间(ms)
    OkToRetryOnAllOperations: true # 是否对所有操作重试
    MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
    MaxAutoRetries: 1 # 同一实例的重试次数
    
hystrix:
    command:
        default:
            execution:
                isolation:
                    thread:
                    	timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms
                    	
eureka:
	client:
		service-url:
			defaultZone: http://localhost:8761/eureka/
```

##### 4.4 新建包com.baidu

##### 4.5 新建启动类

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
/**
* @ClassName RunZuulServerApplication
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/14
* @Version V1.0
**/
@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunZuulServerApplication {
    public static void main(String[] args) {
    	SpringApplication.run(RunZuulServerApplication.class);
    }
}
```

##### 4.6 在com.baidu下新建global.GlobalCorsConfig

### 5 vue项目

##### 5.1 Category.vue.

​	把测试数据删除掉

​	将<v-tree>标签里url的值修改成后台请求地址

##### 5.2 Tree.vue

​	getData方法重新制定resp回调

```js
getData() {
    //加载一级菜单
    this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
        console.log(resp)
        this.db = resp.data.data;
        this.db.forEach(n => n['path'] = [n.name])
    })
}
```

##### 5.3 TreeItem.vue

line:121 修改回调

```js
this.$http.get(this.url, {params: {pid: this.model.id}})
    .then(resp => {
        Vue.set(this.model, 'children', resp.data.data);
        // 封装当前节点的路径
        this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
        });
    }).catch( e => {
    	console.log(e);
    });
```

依次启动eureka-server,xxx-service,zuul-server,vue项目 

保证自己的hosts,nginx没有问题

浏览器输入

```
http://manage.mrshop.com/
```

## 4.商品分类管理(删除)

### 4.1后台

##### 4.1.1 service接口 CategoryService

```java
@ApiOperation(value = "通过id删除分类")
@DeleteMapping(value = "category/del")
Result<JsonObject> delCategory(Integer id);
```

##### 4.1.2 实现类

​	判断当前节点是否是父节点

​	判断当前节点（要删除的节点）的父节点下是否有其他子节点或叶子节点 如果没有就将isParent的值修改为0.

##### 4.1.3 代码实现

```java
@Transactional
@Override
public Result<JsonObject> deleteCategoryById(Integer id) {
    if (ObjectUtil.isNotNull(id) || id > 0){

        //通过id查询当前节点信息
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //判断当前节点是否是父节点
        if (categoryEntity.getIsParent() == 1) return this.setResultError("当前节点为父节点");

        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());



        //通过当前节点的父节点的id 查询当前节点的父节点下是否还有其他子节点
        List<CategoryEntity> categoryList = categoryMapper.selectByExample(example);

        if(categoryList.size() <= 1){
        CategoryEntity categoryEntity1 = new CategoryEntity();
        categoryEntity1.setIsParent(0);
        categoryEntity1.setId(categoryEntity.getParentId());


        categoryMapper.updateByPrimaryKeySelective(categoryEntity1);
    }

    categoryMapper.deleteByPrimaryKey(categoryEntity);
    return this.setResultSuccess();
}
```

##### 4.1.4 vue项目

Category.vue

line:50

```js
this.$http.delete('/category/delete?id='+id)
        .then(resp=>{
          if(resp.data.code != 200){
            this.$message.error("删除失败:"+resp.data.message)
            return;
          }
          this.delKey = new Date().getTime();
          this.$message.success("删除成功!")

        }).catch(error=> console.log(error));
```

## 5.商品分类管理(修改)

### 5.1 后台

##### 5.1.1 mingrui-shop-service-api-xxx的service接口

```java
@ApiOperation(value = "修改分类")
@PutMapping(value = "category/edit")
Result<JSONObject> editCategory(@RequestBody CategoryEntity entity);
```

##### 5.1.2 mingrui-shop-service-xxx 的serviceImpl实现类

```java
@Override
public Result<JSONObject> editCategory(CategoryEntity entity) {
    categoryMapper.updateByPrimaryKeySelective(entity);
    return this.setResultSuccess();
}
```

### 5.2 vue 项目

##### 5.2.1将TreeItem.vue的afterEdit方法this.model.beginEdit改为 this.beginEdit

##### 5.2.2 Category.vue

line:37

```
handleEdit(id, name) {
        this.$http.put('/category/update',{
          id:id,
          name:name
        }).then(resp=>{
          if(resp.data.code == 200){
            this.$message.success("修改成功!!!")
            this.delKey = new Date().getTime();
          }else{
            this.$message.error("修改失败!!!")
          }
        }).catch(error=>console.log(error))
```

## 6.商品分类管理(新增)

### 6.1后台

##### 6.1.1 mingrui-shop-service-api-xxx的service接口

```java
@ApiOperation(value = "新增分类")
@PostMapping(value = "category/add")
Result<JSONObject> addCategory(@RequestBody CategoryEntity entity);
```

##### 6.1.2 mingrui-shop-service-xxx 的serviceImpl实现类

```java
@Override
public Result<JSONObject> addCategory(CategoryEntity entity) {
    categoryMapper.insertSelective(entity);
    return this.setResultSuccess();
}
```

# 品牌管理

## 1.品牌管理（查询）

### 1.1后台 

#### 1.1.1 common-core

 pom.xml

```xml
<!--帮助开发人员快速生成API文档-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>2.9.2</version>
</dependency>
```

#### 1.1.2 在base包下新建BaseDTO

```java
@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页多少条",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){

        return sort + " " + (Boolean.valueOf(order)?"desc":"asc");
    }

}
```

#### 1.1.3 mingrui-shop-api

 pom.xml

```xml
<!--分页工具-->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.2.10</version>
</dependency>
```

#### 1.1.4 mingrui-shop-api-xxx

#### 1.1.5  在com.baidu.shop下新建dto包

​	新建BrandDTO

```java
@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @ApiModelProperty(value = "品牌主键")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "品牌图片")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

    @ApiModelProperty(value = "品牌id集合")
    private String categories;

}
```

#### 1.1.6  entity包下新建BrandEntity

```java
@Table(name = "tb_brand")
@Data
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String name;

    private String image;

    private Character letter;

}
```

#### 1.1.7 service包下新建BrandService接口

```java
@ApiOperation(value = "获取品牌信息")
@GetMapping(value = "brand/getBrandInfo")
Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);
```

#### 1.1.8 mingrui-shop-service-xxx

​	在mapper包下新建BrandMapper

​	 在impl包下新建BrandServiceImpl

​	BrandServiceImpl

```java
@Override
public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {
    //分页
    PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());
    //排序
    Example example = new Example(BrandEntity.class);
    if(!StringUtils.isEmpty(brandDTO.getOrder())) example.setOrderByClause(brandDTO.getOrderByClause());
    if(!StringUtils.isEmpty(brandDTO.getName())){
    	example.createCriteria().andLike("name","%" + brandDTO.getName() + "%");
    }
    //查询
    List<BrandEntity> list = brandMapper.selectByExample(example);
    PageInfo<BrandEntity> pageInfo = new PageInfo<>(list);
    return this.setResultSuccess(pageInfo);
}
```

### 1.2 vue项目

#### 1.2.1 MrBrand.vue

line:108

```js
getData() {
      this.$http
        .get("brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
```

#### 1.2.2  index.js line : 27

route("/item/brand",'/item/MrBrand',"MrBrand"),

## 2.品牌管理(新增)

#### 2.1 后台

##### 2.1.1  在utils包下新建BaiduBeanUtil

##### 2.1.2 mingrui-shop-service-api-xxx

​	service接口

```java
@ApiOperation(value = "新增品牌")
@PostMapping(value = "brand/addBrandInfo")
public Result<JSONObject> save(@Validated({MingruiOperation.Add.class})@RequestBody BrandDTO brandDTO);
```

##### 2.1.3 mingrui-shop-service-xxx

 在mapper包下新建CategoryBrandMapper

```java
import com.baidu.shop.entity.CategoryBrandEntity;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;
/**
* @ClassName CategoryBrandMapper
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/19
* @Version V1.0
**/
//接口可以多继承,InsertListMapper用于批量新增
public interface CategoryBrandMapper extends InsertListMapper<CategoryBrandEntity>,Mapper<CategoryBrandEntity> {
}
```

mingrui-shop-common-core 的pom.xml文件

```xml
<dependency>
    <groupId>com.belerweb</groupId>
    <artifactId>pinyin4j</artifactId>
    <version>2.5.1</version>
</dependency>
```

uitl包下新建PinyinUtil类

```java
import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @ClassName PinyinUtil
 * @Description: TODO
 * @Author sunpeihao
 * @Date 2021/1/22
 * @Version V1.0
 **/
public class PinyinUtil {

    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
        /***
         * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
         * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
         * ^[\u4E00-\u9FA5]+$ 匹配简体
         */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
            //是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
    /***
     * 匹配
     * <P>
     * 根据字符和正则表达式进行匹配
     *
     * @param str 源字符串1
     * @param regex 正则表达式
     *
     * @return true：匹配成功 false：匹配失败
     */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}

```

BrandServiceImpl

```java
@Override
public Result<JSONObject> save(BrandDTO brandDTO) {
    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,BrandEntity.class);
    //品牌首字母
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    //通用mapper新增返回主键
    brandMapper.insertSelective(brandEntity);
    //绑定关系
    if(StringUtils.isEmpty(brandDTO.getCategories())){
        return this.setResultError("分类数据不能为空");
    }
    if(brandDTO.getCategories().contains(",")){
        List<CategoryBrandEntity> list = new ArrayList<>();
        String[] categoryArr = brandDTO.getCategories().split(",");
        Arrays.asList(categoryArr).stream().forEach(str -> {
            CategoryBrandEntity categoryBrandEntity = new
                CategoryBrandEntity();
            categoryBrandEntity.setBrandId(brandEntity.getId());
            categoryBrandEntity.setCategoryId(Integer.parseInt(str));
            list.add(categoryBrandEntity);
        });
        categoryBrandMapper.insertList(list);
    }
	return this.setResultSuccess();
}
```

前台vue项目

​	MrBrandForm submit方法写成后台请求地址

## 3.品牌管理(修改)

vue项目

​	MrBrand.vue   判断isEdit 分辨是品牌修改还是品牌新增

​	MrBrandForm.vue 判断isEdit 分辨请求方式 如果是true 就是put false就是post

后台 service接口

```java
@ApiOperation(value = "修改品牌")
    @PutMapping(value = "brand/save")
    public Result<JSONObject> editBrand(@RequestBody BrandDTO brandDTO);
```



serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> editBrand(BrandDTO brandDTO) {
        BrandEntity brandEntity = TencentBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray([0]),false).toCharArray()[0]);
        brandMapper.updateByPrimaryKeySelective(brandEntity);

        this.deleteCategoryBrandByBrandId(brandEntity.getId());

        this.insertCategoryBrandData(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }
```



## 4.品牌管理(删除)

删除品牌 同时删除中间表信息

代码实现

service接口

```java
@ApiOperation(value = "删除品牌")
    @DeleteMapping(value = "brand/delBrand")
    public Result<JSONObject> deleteBrand(Integer brandId);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> deleteBrand(Integer brandId) {

        //删除品牌
        brandMapper.deleteByPrimaryKey(brandId);

        //通过品牌id删除分类
        this.deleteCategoryBrandByBrandId(brandId);

        return this.setResultSuccess();
    }

    private void deleteCategoryBrandByBrandId(Integer id){
        Example example = new Example(CategoryBrandEntity.class);
        example.createCriteria().andEqualTo("brandId",id);
        categoryBrandMapper.deleteByExample(example);
    }
```

前台vue项目

MrBrand.vue

```js
deleteData(id){
    this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
        this.$http.delete("/brand/delBrand?brandId="+id).then(resp =>{
            if(resp.data.code != 200){
                this.$message.error("删除失败!")
                return ;
            }
        	this.$message.success("删除成功!");
        	this.getData();
        }).catch(error => console.log(error))
    }).catch(()=>this.$message.info("删除取消!"))
}
```



# 规格管理

## 1.规格组查询

service接口

```java
@ApiOperation(value = "规格查询")
    @GetMapping(value = "specgroup/list")
    Result<List<SpecGroupEntity>> list(SpecGroupDTO specGroupDTO);
```

serviceImpl 实现类

```java
@Override
    public Result<List<SpecGroupEntity>> list(SpecGroupDTO specGroupDTO) {

        Example example = new Example(SpecGroupEntity.class);
        example.createCriteria().andEqualTo("cid",
                   TencentBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class).getCid());
        List<SpecGroupEntity> list = specificationMapper.selectByExample(example);

        return this.setResultSuccess(list);
    }
```

前台vue项目

SpecGroup.vue

```js
loadData(){
    this.$http.get("/specgroup/list?cid=" + this.cid)
        .then(({data}) => {
        	this.groups = data.data;
        })
        .catch(() => {
        this.groups = [];
    })
}
```

## 2.规格组新增

service接口

```java
@ApiOperation(value = "规格新增")
    @PostMapping(value = "specgroup/save")
    Result<JSONObject> save(@RequestBody SpecGroupDTO specGroupDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> save(SpecGroupDTO specGroupDTO) {

        specificationMapper.insertSelective(TencentBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));

        return this.setResultSuccess();
    }
```

vue项目

SpecGroup.vue

```js
save(){
    this.$http({
        method: this.isEdit ? 'put' : 'post',
        url: '/specgroup/save',
        data: this.group
    }).then(() => {
    // 关闭窗口
        this.show = false;
        this.$message.success("保存成功！");
        this.loadData();
    }).catch(() => {
    	this.$message.error("保存失败！");
    });
}
```

## 3.规格组修改

service接口

```java
@ApiOperation(value = "规格修改")
    @PutMapping(value = "specgroup/save")
    Result<JSONObject> edit(@RequestBody SpecGroupDTO specGroupDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> edit(SpecGroupDTO specGroupDTO) {

        specificationMapper.updateByPrimaryKeySelective(TencentBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));

        return this.setResultSuccess();
    }
```

前台vue项目与新增使用同一个方法

## 4.规格组删除

service接口

```java
@ApiOperation(value = "规格删除")
    @DeleteMapping(value = "specgroup/delete/{id}")
    Result<JSONObject> delete(@PathVariable Integer id);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> delete(Integer id) {

        //删除规格组之前需要先判断一下当前规格组下是否有规格参数
        //true : 不能被删除
        //false ：删除

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",id);

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        if (specParamEntities.size() >= 1) return this.setResultError("该规格组下有规格参数,无法删除");

        specificationMapper.deleteByPrimaryKey(id);

        return this.setResultSuccess();
    }
```

前台vue项目

SpecGroup.vue

```js
deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/specgroup/delete/" + id)
                .then((resp) => {
                    if(resp.data.code != 200){
                        this.$message.error(resp.data.message)
                        return ;
                    }
                    this.$message.success("删除成功");
                    this.loadData();
                })
          })
      }
```



## 5.规格参数查询

service接口

```java
@ApiOperation(value = "规格参数查询")
    @GetMapping(value = "specparam/list")
    Result<List<SpecParamEntity>> list(SpecParamDTO specParamDTO);
```

serviceImpl 实现类

```java
@Override
    public Result<List<SpecParamEntity>> list(SpecParamDTO specParamDTO) {

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamDTO.getGroupId());
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        return this.setResultSuccess(specParamEntities);
    }
```

vue项目

SpecParam.vue

```js
loadData() {
      this.$http
        .get("/specparam/list?groupId=" + this.group.id)
        .then(({ data }) => {
          data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = data.data;
        })
        .catch(() => {
          this.params = [];
        });
    }
```

## 6.规格参数新增

service接口

```java
@ApiOperation(value = "规格参数新增")
@PostMapping(value = "specparam/save")
Result<JSONObject> saveSpecParam(@RequestBody SpecParamDTO specParamDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONObject> saveSpecParam(SpecParamDTO specParamDTO) {

        specParamMapper.insertSelective(TencentBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));

        return this.setResultSuccess();
    }
```

vue项目

SpecParam.vue

```js
save(){
      const p = {};
      Object.assign(p, this.param);
      p.segments = p.segments.map(s => s.join("-")).join(",")
      this.$http({
          method: this.isEdit ? 'put' : 'post',
          url: '/specparam/save',
          data: p,
      }).then(() => {
        // 关闭窗口
        this.show = false;
        this.$message.success("保存成功！");
        this.loadData();
      }).catch(() => {
          this.$message.error("保存失败！");
      });
    }
```

## 7.规格参数修改

service接口

```java
@ApiOperation(value = "规格参数修改")
@PutMapping(value = "specparam/save")
Result<JSONObject> editSpecParam(@RequestBody SpecParamDTO specParamDTO);
```

serviceImpl 实现类

```java
@Override
@Transactional
public Result<JSONObject> editSpecParam(SpecParamDTO specParamDTO) {

    specParamMapper.updateByPrimaryKeySelective(TencentBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));

    return this.setResultSuccess();
}
```

vue项目

SpecParam.vue

```js
save(){
      const p = {};
      Object.assign(p, this.param);
      p.segments = p.segments.map(s => s.join("-")).join(",")
      this.$http({
          method: this.isEdit ? 'put' : 'post',
          url: '/specparam/save',
          data: p,
      }).then(() => {
        // 关闭窗口
        this.show = false;
        this.$message.success("保存成功！");
        this.loadData();
      }).catch(() => {
          this.$message.error("保存失败！");
      });
    }
```

## 8.规格参数删除

service接口

```java
@ApiOperation(value = "规格参数删除")
@DeleteMapping(value = "specparam/delete")
Result<JSONObject> deleteSpecParamById(Integer id);
```

serviceImpl 实现类

```java
@Override
@Transactional
public Result<JSONObject> deleteSpecParamById(Integer id) {

    specParamMapper.deleteByPrimaryKey(id);

    return this.setResultSuccess();
}
```

vue项目

SpecParam.vue

```js
deleteParam(id) {
      this.$message.confirm("确认要删除该参数吗？")
      .then(() => {
          this.$http.delete("/specparam/delete?id=" + id)
          .then(() => {
              this.$message.success("删除成功");
              this.loadData()
          })
          .catch(() => {
              this.$message.error("删除失败");
          })
      })
    }
```

# fastDFS

把fastDFS安装到Linux系统里

后台

mingrui-shop-upload-server

导入fastDFS相关依赖

application.yml

```properties
fdfs:
    so-timeout: 1501
    connect-timeout: 601
    thumb-image: # 缩略图
        width: 60
        height: 60
    tracker-list: # tracker地址
    - 119.45.191.248:22122
mingrui:
    upload:
        path:
            windows: E:\\upload
            linux: /shenyaqi/upload
    img:
        #图片服务器主机
        host: http://119.45.191.248/
```

 config包下新建配置类FastClientImporter

```java
import com.github.tobato.fastdfs.FdfsClientConfig;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableMBeanExport;
import org.springframework.context.annotation.Import;
import org.springframework.jmx.support.RegistrationPolicy;
/**
* @ClassName FastClientImporter
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/24
* @Version V1.0
**/
@Configuration
@Import(FdfsClientConfig.class)
// 解决jmx重复注册bean的问题
@EnableMBeanExport(registration = RegistrationPolicy.IGNORE_EXISTING)
public class FastClientImporter {
}
```

上传文件controller

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import java.io.IOException;
import java.io.InputStream;
/**
* @ClassName FastDFSUploadController
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/24
* @Version V1.0
**/
@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;
    
    @Autowired
    private FastFileStorageClient storageClient;
    
    @Autowired
    private ThumbImageConfig thumbImageConfig;
    
    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {
        InputStream inputStream = file.getInputStream();//获取文件输入流
        
        String filename = file.getOriginalFilename();//文件名
        
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(inputStream, file.getSize(), ex, null);//上传
        
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        
        // 获取缩略图路径
        String path = thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        
        log.info("缩略图路径:{}", path);
        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }
}

```



# 商品列表管理

## 1.商品列表查询

service接口

```java
@ApiOperation(value = "获取spu信息")
@GetMapping(value = "goods/getSpuInfo")
Result<PageInfo<SpuEntity>> getSpuInfo(SpuDTO spuDTO);
```

serviceImpl 实现类

```java
@Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {

        if (ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows())){
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());
        }

        Example example = new Example(SpuEntity.class);

        if (ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2){
            example.createCriteria().andEqualTo("saleable",spuDTO.getSaleable());
        }

        if (!StringUtils.isEmpty(spuDTO.getTitle())){
            example.createCriteria().andLike("title","%"+spuDTO.getTitle()+"%");
        }

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = TencentBeanUtil.copyProperties(spuEntity, SpuDTO.class);

            //1.
            /*CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(spuEntity.getCid1());
            CategoryEntity categoryEntity2 = categoryMapper.selectByPrimaryKey(spuEntity.getCid2());
            CategoryEntity categoryEntity3 = categoryMapper.selectByPrimaryKey(spuEntity.getCid3());
            spuDTO1.setCategoryName(categoryEntity.getName() + "/" + categoryEntity2.getName() + "/" + categoryEntity3.getName());*/

            //2.
            /*List<Integer> cidList = new ArrayList<>();
            cidList.add(spuEntity.getCid1());
            cidList.add(spuEntity.getCid2());
            cidList.add(spuEntity.getCid3());

            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(cidList);
            String categoryName = "";
            List<String> strings = new ArrayList<>();
            strings.set(0,"");
            categoryEntities.stream().forEach(categoryEntity -> {
                strings.set(0,strings.get(0) + categoryEntity.getName() + "/");
            });
            categoryName = strings.get(0).substring(0,strings.get(0).length());*/

            //3.
            List<Integer> cidList = Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3());
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(cidList);
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);

        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "",spuDTOList);
    }
```

vue项目

Goods.vue

```js
getDataFromApi() {
        this.loading = false;
        this.$http.get('/goods/getSpuInfo',{
          params:{
            page:this.pagination.page,
            rows:this.pagination.rowsPerPage,
            sort:this.pagination.sortBy,
            order:this.pagination.descending,
            saleable:this.search.saleable,
            title:this.search.key
          }
        }).then(resp => {
          this.items = resp.data.data;
          this.totalItems = resp.data.message -0;
        }).catch(error => console.log(error));

        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```

## 2.商品列表新增

service 接口

```java
@ApiOperation(value = "新增商品")
@PostMapping(value = "goods/save")
Result<JSONUtil> saveGoods(@Validated({MingruiOperation.Add.class}) @RequestBody SpuDTO spuDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONUtil> saveGoods(SpuDTO spuDTO) {
        //spu
        final Date date = new Date();
        SpuEntity spuEntity = TencentBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);

        //spuDetail
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = TencentBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);

        //sku
        this.saveSkusAndStock(spuDTO,spuEntity.getId(),date);

        return this.setResultSuccess();
    }

private void saveSkusAndStock(SpuDTO spuDTO,Integer spuId,Date date){
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {
            SkuEntity skuEntity = TencentBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuId);
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });
    }
```

前台vue项目

GoodsForm.vue

```js
submit() {
      // 表单校验。
      if(!this.$refs.basic.validate){
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id,v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title = goodsParams.title + " " + Object.values(rest).map(v => v.v).join(" ");
          const obj = {};
          Object.values(rest).forEach(v => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map(image => image.data).join(",") : '',
            ownSpec: JSON.stringify(obj) // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    }
```

Editor.vue

```js
onFileChange(e) {
        var fileInput = e.target;
        if (fileInput.files.length === 0) {
          return
        }
        this.editor.focus();
        if (fileInput.files[0].size > this.maxUploadSize) {
          this.$alert('图片不能大于500KB', '图片尺寸过大', {
            confirmButtonText: '确定',
            type: 'warning',
          })
        }
        var data = new FormData;
        data.append(this.fileName, fileInput.files[0]);
        this.$http.post(this.uploadUrl, data)
          .then(res => {
            if (res.data.data) {
              this.editor.insertEmbed(this.editor.getSelection().index, 'image', res.data.data)
            }
          })
      }
```



## 3.商品列表修改

service 接口

```java
@ApiOperation(value = "通过spuid获取spuDetail信息")
@GetMapping(value = "goods/getSpuDetailBySpuId")
Result<List<SpuEntity>> getSpuDetailBySpuId(Integer spuId);

@ApiOperation(value = "通过spuid获取sku信息")
@GetMapping(value = "goods/getSkuBySpuId")
Result<List<SkuDTO>> getSkuBySpuId(Integer spuId);

@ApiOperation(value = "修改商品")
@PutMapping(value = "goods/save")
Result<JSONUtil> editGoods(@Validated({MingruiOperation.Update.class}) @RequestBody SpuDTO spuDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONUtil> editGoods(SpuDTO spuDTO) {

        final Date date = new Date();
        //spu
        SpuEntity spuEntity = TencentBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setLastUpdateTime(date);
        spuMapper.updateByPrimaryKeySelective(spuEntity);

        //spuDetail
        SpuDetailEntity spuDetailEntity = TencentBeanUtil.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class);
        spuDetailMapper.updateByPrimaryKeySelective(spuDetailEntity);

        //skus and stock
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuEntity.getId());
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        List<Long> skuId = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuId);
        stockMapper.deleteByIdList(skuId);
        this.saveSkusAndStock(spuDTO,spuEntity.getId(),date);

        return this.setResultSuccess();
    }

    @Override
    public Result<List<SkuDTO>> getSkuBySpuId(Integer spuId) {
        List<SkuDTO> list = skuMapper.getSkuBySpuId(spuId);

        return this.setResultSuccess(list);
    }

    @Override
    public Result<List<SpuEntity>> getSpuDetailBySpuId(Integer spuId) {

        SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);

        return this.setResultSuccess(spuDetailEntity);
    }
private void saveSkusAndStock(SpuDTO spuDTO,Integer spuId,Date date){
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {
            SkuEntity skuEntity = TencentBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuId);
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });
    }
```

vue项目

GoodsForm.vue

```js
submit() {
      // 表单校验。
      if(!this.$refs.basic.validate){
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id,v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title = goodsParams.title + " " + Object.values(rest).map(v => v.v).join(" ");
          const obj = {};
          Object.values(rest).forEach(v => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map(image => image.data).join(",") : '',
            ownSpec: JSON.stringify(obj) // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    }
```

## 4.商品列表删除

service 接口

```java
@ApiOperation(value = "删除商品")
@DeleteMapping(value = "goods/delete")
Result<JSONUtil> deleteGoods(Integer spuId);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONUtil> deleteGoods(Integer spuId) {

        //spu
        spuMapper.deleteByPrimaryKey(spuId);

        //spuDetail
        spuDetailMapper.deleteByPrimaryKey(spuId);

        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        List<Long> skuId = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuId);
        stockMapper.deleteByIdList(skuId);

        return this.setResultSuccess();
    }
```

Goods.vue

```js
deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });
      }
```

## 5.商品列表上下架

service 接口

```java
@ApiOperation(value = "上下架商品")
@PutMapping(value = "goods/down")
Result<JSONUtil> downGoods(@Validated({MingruiOperation.Update.class}) @RequestBody SpuDTO spuDTO);
```

serviceImpl 实现类

```java
@Override
    @Transactional
    public Result<JSONUtil> downGoods(SpuDTO spuDTO) {

        SpuEntity spuEntity = TencentBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        if (spuEntity.getSaleable() == 1){
            spuEntity.setSaleable(0);
        }else{
            spuEntity.setSaleable(1);
        }

        spuMapper.updateByPrimaryKeySelective(spuEntity);

        return this.setResultSuccess();
    }
```

Goods.vue

给上架 和 下架按钮一个点击事件

```js
down(row){
        this.$http.put('/goods/down',row).then((resp)=>{
          console.log(resp)
          if(resp.data.code != 200) return this.$message.error("失败");
          this.getDataFromApi();
          this.$message.info('成功!');
        }).catch(error => console.log(error));
      }
```

# Elasticsearch安装

将压缩包上传到linux系统中

```linux
tar -zxvf elasticsearch-7.5.1-linux-x86_64.tar.gz #解压压缩包
groupadd esgroup #创建用户组
useradd esuser -g esgroup -p 123456 #在用户组下新建用户
cd elasticsearch-7.5.1/config/ #进入配置文件目录
vi jvm.options #修改JVM参数(默认1G)
-Xms512m
-Xmx512m
```

保存并退出

```
vi elasticsearch.yml
cluster.name: my-application  #集群名称
node.name: node-1 #当前节点名称
path.data: /sph/es/elasticsearch-7.5.1/data #数据存放目录
path.logs: /sph/es/elasticsearch-7.5.1/logs #日志目录
network.host: 0.0.0.0 #允许任意ip访问
discovery.seed_hosts: ["81.70.218.89"] #所有节点ip,由于当前环境采用单节点,所以只写当前节点ip地址
cluster.initial_master_nodes: ["node-1"] #声明master节点,由于当前是单节点环境所以master节点就是当前节点[此处可以写ip:9200也可以写node.name]
```

保存并退出

```
cd ../../ #进入es的上级目录
```

```
chown -R esuser:esgroup elasticsearch-7.5.1 #给用户授权
su esuser #切换用户
```

```
cd elasticsearch-7.5.1/bin/ #进入bin目录
./elasticsearch 启动es
```

如果出现error

```
su root
sysctl -w vm.max_map_count=262144
sysctl -a|grep vm.max_map_count
su esuser
```

浏览器访问ip:9200 访问成功 es就安装成功

##  安装ik分词器

进入es目录下的plugins目录

```
mkdir ik
cd ik
```

将elasticsearch-analysis-ik-7.5.1.zip上传到ik目录

```
unzip elasticsearch-analysis-ik-7.5.1.zip #解压压缩包
# 解压完成之后最好切换回root 用户重新给文件夹授权！！！！
```

```
rm -rf elasticsearch-analysis-ik-7.5.1.zip #删除压缩包
```

重启es

```
cd ../bin/
./elasticsearch
./elasticsearch -d #后台启动
```

## 安装kibana(可视化工具)

解压kibana解压包

### 配置运行

#### 配置

进入安装目录下的config目录，修改kibana.yml文件：

修改elasticsearch服务器的地址：

```
elasticsearch.hosts: ["http://81.70.218.89:9200"] #119.45.191.248替换成自己虚拟的IP地址
```

#### 运行

进入安装目录下的bin目录：

双击kibana.bat运行



浏览器输入ip:5601